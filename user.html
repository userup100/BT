<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Certificate Verification dApp - User</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    .btn { padding: 0.5rem 1rem; margin: 0.25rem 0; cursor: pointer; }
    .primary { background-color: #007bff; color: white; border: none; }
    .badge { padding: 0.5rem; font-weight: bold; }
    .ok { color: green; }
    .fail { color: red; }
    .log { white-space: pre-wrap; background: #f5f5f5; padding: 1rem; height: 8rem; overflow-y: auto; }
    label { display: block; margin-top: 0.5rem; }
    input, textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>User Verification Panel - Certificate Verification dApp</h1>

  <label>Holder Name</label>
  <input id="u_holderName" placeholder="Sai Raj" />

  <label>Roll No</label>
  <input id="u_rollNo" placeholder="260" />

  <label>Course</label>
  <input id="u_course" placeholder="B.E. Computer" />

  <label>Year</label>
  <input id="u_year" type="number" value="2025" />

  <label>Issuer (owner address)</label>
  <input id="u_issuer" placeholder="0x..." />

  <label>Certificate File (pdf/png/jpg/json/txt)</label>
  <input id="u_file" type="file" accept=".pdf,.png,.jpg,.jpeg,.json,.txt" />

  <!-- <textarea id="u_text" placeholder='{"name":"Alice",...}' rows="5"></textarea> -->

  <button id="u_compute" class="btn">Compute ID & Hash</button>

  <label>Certificate ID</label>
  <input id="u_certId" placeholder="0x... (auto if computed)" readonly />

  <label>Content Hash</label>
  <input id="u_contentHash" placeholder="0x... (auto if computed)" readonly />

  <button id="u_verify" class="btn primary">Verify</button>

  <span id="u_result" class="badge">Result: â€”</span>

  <pre id="u_log" class="log"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    (function () {
      const { ethers } = window;

      const CONTRACT_ADDRESS = "0xd0d409F68DE81b314612474bf10e0Cf98252e91a"; // Your deployed address
      const CONTRACT_ABI = [/* Your full ABI JSON here */ ];

      const REQUIRED_CHAIN_ID = "0xAA36A7"; // Example: Sepolia testnet chain id (hex). Please update to your network!

      let provider, contractRead;

      const elems = {
        holderName: document.getElementById("u_holderName"),
        rollNo: document.getElementById("u_rollNo"),
        course: document.getElementById("u_course"),
        year: document.getElementById("u_year"),
        issuer: document.getElementById("u_issuer"),
        file: document.getElementById("u_file"),
        compute: document.getElementById("u_compute"),
        certId: document.getElementById("u_certId"),
        contentHash: document.getElementById("u_contentHash"),
        verifyBtn: document.getElementById("u_verify"),
        result: document.getElementById("u_result"),
        log: document.getElementById("u_log"),
      };

      async function initProvider() {
        if (!window.ethereum) {
          alert("MetaMask is required. Please install it from https://metamask.io/");
          throw new Error("MetaMask not found");
        }
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const currentChainId = await window.ethereum.request({ method: "eth_chainId" });
        if (currentChainId !== REQUIRED_CHAIN_ID) {
          alert("Please switch your MetaMask network to the expected network.");
          throw new Error("Incorrect MetaMask network");
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        contractRead = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
      }

      function hashText(text) {
        const bytes = ethers.utils.toUtf8Bytes(text);
        return ethers.utils.keccak256(bytes);
      }

      function buildCertId(holderName, rollNo, course, year, issuer) {
        return ethers.utils.solidityKeccak256(
          ["string", "string", "string", "uint32", "address"],
          [holderName, rollNo, course, Number(year), issuer]
        );
      }

      function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      elems.compute.addEventListener("click", async () => {
        try {
          let cHash;
          if (elems.file.files.length > 0) {
            const fileBuffer = await readFileAsArrayBuffer(elems.file.files[0]);
            cHash = ethers.utils.keccak256(new Uint8Array(fileBuffer));
          } else {
            cHash = hashText(
              JSON.stringify({
                holderName: elems.holderName.value,
                rollNo: elems.rollNo.value,
                course: elems.course.value,
                year: Number(elems.year.value),
                issuer: elems.issuer.value,
              })
            );
          }

          const id = buildCertId(
            elems.holderName.value,
            elems.rollNo.value,
            elems.course.value,
            elems.year.value,
            elems.issuer.value
          );

          elems.certId.value = id;
          elems.contentHash.value = cHash;
          elems.log.textContent = `Computed\nID: ${id}\nContent Hash: ${cHash}`;
        } catch (e) {
          elems.log.textContent = `Compute error: ${e.message}`;
        }
      });

      elems.verifyBtn.addEventListener("click", async () => {
        try {
          await initProvider();
          const ok = await contractRead.verify(elems.certId.value, elems.contentHash.value);
          elems.result.textContent = ok ? "Result: VALID" : "Result: INVALID";
          elems.result.className = ok ? "badge ok" : "badge fail";

          const core = await contractRead.getCertificateCore(elems.certId.value);
          const text = await contractRead.getCertificateText(elems.certId.value);
          elems.log.textContent = `Verify: ${ok}
Present: ${core.present}
Revoked: ${core.revoked}
Issuer: ${core.issuer}
Name: ${text.holderName}
Course: ${text.course}`;
        } catch (e) {
          elems.log.textContent = `Verify error: ${e.message}`;
        }
      });
    })();
  </script>
</body>
</html>
